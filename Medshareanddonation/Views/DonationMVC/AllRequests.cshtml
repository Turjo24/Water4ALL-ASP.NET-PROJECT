<h2>All Donation Requests</h2>

<table id="allRequestsTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Location</th>
            <th>Liters</th>
            <th>Reason</th>
            <th>Status</th>
            <th>Volunteer</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Rows will be added here dynamically -->
    </tbody>
</table>

@section Scripts {
    <script>
        async function loadAllRequests() {
            try {
                const token = localStorage.getItem("token");
                if (!token) {
                    alert("Please login to view requests.");
                    return;
                }

                const response = await fetch("https://localhost:7217/api/donation/AllRequests", {
                    headers: {
                        "Authorization": `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error("Failed to fetch requests");

                const requests = await response.json();
                const tbody = document.querySelector("#allRequestsTable tbody");
                tbody.innerHTML = ""; // clear existing rows

                requests.forEach(req => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${req.name}</td>
                        <td>${req.phoneNumber}</td>
                        <td>${req.locationAddress}</td>
                        <td>${req.waterLiters}</td>
                        <td>${req.reason}</td>
                        <td>${req.status}</td>
                        <td>${req.assignedVolunteerId || "-"}</td>
                        <td>
                            <a href="#" onclick="changeStatus(${req.id}, 'Approved')">Approve</a> |
                            <a href="#" onclick="changeStatus(${req.id}, 'Rejected')">Reject</a>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error(err);
                alert("Error loading donation requests");
            }
        }

        async function changeStatus(id, status) {
            try {
                const token = localStorage.getItem("token");
                const response = await fetch(`https://localhost:7217/api/donation/ChangeStatus/${id}?status=${status}`, {
                    method: "PUT",
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) throw new Error("Failed to change status");

                alert("Status updated!");
                loadAllRequests(); // refresh table
            } catch (err) {
                console.error(err);
                alert("Error updating status");
            }
        }

        // load requests on page load
        loadAllRequests();
    </script>
}
