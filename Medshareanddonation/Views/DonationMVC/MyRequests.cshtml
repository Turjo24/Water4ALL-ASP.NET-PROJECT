<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Donation Request</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#3B82F6',
                secondary: '#10B981'
              }
            }
          }
        };
    </script>

    <style>
        html, body {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

            html::-webkit-scrollbar,
            body::-webkit-scrollbar {
                display: none;
            }
    </style>
</head>

<body class="bg-white text-gray-800 font-sans p-8">
    <h1 class="text-2xl font-bold mt-6 mb-10 text-center">My Donation Requests</h1>

    <!-- Header row -->
    <div class="grid grid-cols-12 gap-4 font-bold border-b pb-2 mb-2 px-10 bg-neutral-200/50 p-2">
        <div class="col-span-2 text-center">Name</div>
        <div class="col-span-2 text-center">Phone</div>
        <div class="col-span-2 text-center">Address</div>
        <div class="col-span-1 text-center">Liters</div>
        <div class="col-span-2 text-center">Reason</div>
        <div class="col-span-1 text-center">Status</div>
        <div class="col-span-2 text-center">Assigned Volunteer</div>
    </div>

    <!-- Container for data rows -->
    <div id="requestGrid" class="px-10 space-y-1"></div>

    <script>
        let volunteerCache = new Map();

        async function getVolunteerInfo(volunteerId) {
          if (!volunteerId || volunteerId === "NULL") {
            return null;
          }

          // Check cache first
          if (volunteerCache.has(volunteerId)) {
            return volunteerCache.get(volunteerId);
          }

          try {
            const token = localStorage.getItem("token");
            const response = await fetch(`https://localhost:7217/api/user/VolunteerInfo/${volunteerId}`, {
              headers: {
                "Authorization": `Bearer ${token}`
              }
            });

            if (response.ok) {
              const volunteer = await response.json();
              volunteerCache.set(volunteerId, volunteer);
              return volunteer;
            }
          } catch (err) {
            console.error("Error fetching volunteer info:", err);
          }

          return null;
        }

        async function loadMyRequests() {
          try {
            const token = localStorage.getItem("token");
            if (!token) {
              alert("Please login to view your requests.");
              return;
            }

            const response = await fetch("https://localhost:7217/api/donation/MyRequests", {
              headers: {
                "Authorization": `Bearer ${token}`
              }
            });

            if (!response.ok) throw new Error("Failed to fetch your requests");

            const requests = await response.json();
            const grid = document.getElementById("requestGrid");
            grid.innerHTML = "";

            const statusMap = {
              Approved: {
                cls: "text-green-500 bg-green-200/50 border-green-500",
                color: "#22C55E"
              },
              Rejected: {
                cls: "text-red-500 bg-red-200/50 border-red-500",
                color: "#EF4444"
              },
              Pending: {
                cls: "text-yellow-500 bg-yellow-100 border-yellow-500",
                color: "#FE971E"
              }
            };

            // Process each request
            for (const req of requests) {
              const row = document.createElement('div');
              row.className = "grid grid-cols-12 gap-4 border-b min-h-[10vh] items-center py-2";

              const status = statusMap[req.status] || statusMap.Pending;

              // Get volunteer information
              const volunteer = await getVolunteerInfo(req.assignedVolunteerId);

              let volunteerInfo = '';
              let volunteerClass = 'bg-gray-50 border border-gray-200 text-gray-500';

              if (volunteer) {
                volunteerInfo = `
                  <div class="font-semibold text-blue-700">${volunteer.name}</div>
                  <div class="text-xs text-blue-600">${volunteer.email}</div>
                `;
                volunteerClass = 'bg-blue-50 border border-blue-200 text-blue-700';
              } else if (req.assignedVolunteerId && req.assignedVolunteerId !== "NULL") {
                volunteerInfo = `
                  <div class="font-semibold text-green-700">Volunteer Assigned</div>
                  <div class="text-xs text-green-600">ID: ${req.assignedVolunteerId.substring(0, 8)}...</div>
                `;
                volunteerClass = 'bg-green-50 border border-green-200 text-green-700';
              } else {
                volunteerInfo = `
                  <div class="font-semibold text-gray-500">Not Assigned</div>
                  <div class="text-xs text-gray-400">No volunteer yet</div>
                `;
              }

              row.innerHTML = `
                <div class="col-span-2 text-center">${req.name}</div>
                <div class="col-span-2 text-center">${req.phoneNumber}</div>
                <div class="col-span-2 text-center text-sm">${req.locationAddress}</div>
                <div class="col-span-1 text-center">${req.waterLiters} Liters</div>
                <div class="col-span-2 text-center text-xs">${req.reason}</div>
                <div class="col-span-1 flex items-center text-xs justify-center gap-2 border-2 p-1 rounded-lg ${status.cls}">
                  <svg fill="${status.color}" width="16" height="16" viewBox="0 0 20 20">
                    <path d="M7.8 10a2.2 2.2 0 0 0 4.4 0 2.2 2.2 0 0 0-4.4 0z"/>
                  </svg>
                  <span class="-translate-x-2">${req.status}</span>
                </div>
                <div class="col-span-2 text-center text-xs">
                  <div class="rounded-lg px-3 py-2 border ${volunteerClass} max-w-full">
                    ${volunteerInfo}
                  </div>
                </div>
              `;

              grid.appendChild(row);
            }

            // Show message if no requests
            if (requests.length === 0) {
              const noDataDiv = document.createElement('div');
              noDataDiv.className = 'text-center py-8 text-gray-500';
              noDataDiv.innerHTML = `
                <div class="text-lg font-semibold">No donation requests found</div>
                <div class="text-sm mt-2">You haven't submitted any donation requests yet.</div>
              `;
              grid.appendChild(noDataDiv);
            }

          } catch (err) {
            console.error(err);
            alert("Error loading your donation requests");
          }
        }

        // Load when DOM is ready
        document.addEventListener("DOMContentLoaded", loadMyRequests);
    </script>
</body>
</html>