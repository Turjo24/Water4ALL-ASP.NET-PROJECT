<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assigned Donations</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-100 min-h-screen p-8 font-sans">

    <div class="max-w-7xl mx-auto bg-white shadow-xl rounded-2xl p-8 border border-gray-200">

        <!-- Heading -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-700 mb-2">Assigned Donations</h1>
            <p class="text-lg text-gray-600">Here are the donations that have been assigned to you.</p>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto rounded-xl border border-gray-300 shadow-sm">
            <table class="min-w-full border-collapse">
                <thead class="bg-blue-600 text-white">
                    <tr>
                        <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">ID</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Name</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Phone</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Address</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Water (L)</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Reason</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-sm font-semibold uppercase tracking-wider">Created At</th>
                    </tr>
                </thead>
                <tbody id="donationsTable">
                    <!-- Placeholder row styled same as data rows -->
                    <tr class="bg-white shadow-sm rounded-lg hover:bg-blue-50 transition duration-150">
                        <td colspan="8" class="text-center py-6 text-gray-500 rounded-lg">Loading donations...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const userRole = localStorage.getItem("userRole");
          if (userRole !== "Volunteer") {
            alert("You are not authorized to view this page.");
            return;
          }
          fetchAssignedDonations();
        });

        async function fetchAssignedDonations() {
          const volunteerId = localStorage.getItem("userId");
          const token = localStorage.getItem("token");
          const tbody = document.getElementById("donationsTable");

          if (!volunteerId || !token) {
            tbody.innerHTML = `
              <tr class="bg-white shadow-sm rounded-lg hover:bg-blue-50 transition duration-150">
                <td colspan="8" class="text-center text-red-500 font-semibold py-4 rounded-lg">
                  User not logged in properly.
                </td>
              </tr>`;
            return;
          }

          try {
            const res = await fetch(`https://localhost:7217/api/Volunteer/${volunteerId}/AssignedDonations`, {
              headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) {
              const errorData = await res.json().catch(() => ({ message: res.statusText }));
              tbody.innerHTML = `
                <tr class="bg-white shadow-sm rounded-lg hover:bg-blue-50 transition duration-150">
                  <td colspan="8" class="text-center text-red-500 font-semibold py-4 rounded-lg">
                    ${errorData.message || 'Failed to load donations'}
                  </td>
                </tr>`;
              return;
            }

            const donations = await res.json();
            tbody.innerHTML = "";

            if (donations.length === 0) {
              tbody.innerHTML = `
                <tr class="bg-white shadow-sm rounded-lg hover:bg-blue-50 transition duration-150">
                  <td colspan="8" class="text-center text-gray-500 italic py-4 rounded-lg">
                    No donations assigned yet.
                  </td>
                </tr>`;
              return;
            }

            donations.forEach((d) => {
              let statusClass = "bg-yellow-100 text-yellow-800"; // default pending
              if (d.status.toLowerCase() === "complete") {
                statusClass = "bg-green-100 text-green-800";
              } else if (d.status.toLowerCase() === "rejected") {
                statusClass = "bg-red-100 text-red-800";
              }

              const row = document.createElement("tr");
              row.className = `
                bg-white shadow-sm rounded-lg
                hover:bg-blue-50 transition duration-150
              `;
              row.innerHTML = `
                <td class="px-4 py-3 text-gray-800 font-medium rounded-l-lg">${d.id}</td>
                <td class="px-4 py-3 text-gray-700">${d.name || 'N/A'}</td>
                <td class="px-4 py-3 text-gray-700">${d.phoneNumber || 'N/A'}</td>
                <td class="px-4 py-3 text-gray-700">${d.locationAddress || 'N/A'}</td>
                <td class="px-4 py-3 text-gray-700">${d.waterLiters || 'N/A'}</td>
                <td class="px-4 py-3 text-gray-700">${d.reason || 'N/A'}</td>
                <td class="px-4 py-3"><span class="px-2 py-1 rounded font-semibold ${statusClass}">${d.status}</span></td>
                <td class="px-4 py-3 text-gray-700 rounded-r-lg">${new Date(d.createdAt).toLocaleString()}</td>
              `;
              tbody.appendChild(row);
            });

          } catch (error) {
            console.error("Error fetching donations:", error);
            tbody.innerHTML = `
              <tr class="bg-white shadow-sm rounded-lg hover:bg-blue-50 transition duration-150">
                <td colspan="8" class="text-center text-red-500 font-semibold py-4 rounded-lg">
                  Network error: ${error.message}
                </td>
              </tr>`;
          }
        }
    </script>

</body>
</html>
